# Migration file for creating "publication" nodes from BBDD.
#
# This file contains much of the information which we
# used to specify in the "Migration" class in Drupal 7.
# But why write code if you can write YAML?
# This is how we declare a Migration the Drupal 8 way.

##################### BASIC INFORMATION ###################

id: oira_files
label: 'Public Files'
audit: true
migration_group: oira_migrate_files

##################### BASIC INFORMATION ###################



########################## SOURCE #########################

source:
  plugin: d7_file
  scheme: public
  constants:
    # The tool configuring this migration must set source_base_path. It
    # represents the fully qualified path relative to which URIs in the files
    # table are specified, and must end with a /. See source_full_path
    # configuration in this migration's process pipeline as an example.
    source_base_path: ''
    file_destination: 'public://'
    file_origin: 'https://oiraproject.eu/sites/default/files'

########################## SOURCE #########################



########################## PROCESS ########################
process:
  # If you are using this file to build a custom migration consider removing
  # the tid field to allow incremental migrations.
  # tid: tid
  filename: filename


  # Prepare the path for the file origin
  file_source:
    -
      plugin: concat
      delimiter: /
      source:
        - constants/file_origin
        - constants/file_name
    -
      plugin: urlencode

  # Prepare the path for the file destination
  file_destination:
    -
      plugin: concat
      delimiter: ''
      source:
        - uri
        - constants/file_name
    -
      plugin: urlencode

  uri:
    -
      plugin: file_copy
      source:
        - '@file_source'
        - '@file_destination'
    # -
    #   plugin: file_import
    #   source: constants/file_origin

  filemime: filemime
  # No need to migrate filesize, it is computed when file entities are saved.
  # filesize: filesize
  status: status
  # Drupal 7 didn't keep track of the file's creation or update time -- all it
  # had was the vague "timestamp" column. So we'll use it for both.
  created: created
  changed: changed
  uid: uid

########################## PROCESS ########################



######################## DETINATION #######################

destination:
  plugin: entity:file

######################## DETINATION #######################



######################## DEPENDENCIES #####################

# We specify that this migration depends on the unops_project_migrate module.
# Based on this dependency, this migration will be removed when the
# unops_project_migrate module is uninstalled.
dependencies:
  enforced:
    module:
      - custom_migrate

# Declare optional dependencies on another migration for this migration.
# This one has none.
migration_dependencies:
  required:
    - d7_user

######################## DEPENDENCIES #####################
